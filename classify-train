#!/usr/bin/python
import os, sys
import random
import itertools
import time

from classify import gst_init
from classify import TMP_MFCCS as MFCCS
from classify import TMP_CLASSES as CLASSES
from classify import TMP_HIDDEN_SIZE as HIDDEN_SIZE
from classify import Trainer, lr_steps, categorised_files

TRAIN_FILE_LENGTH=5

NET_LOG_FILE = "classify.log"

TRAIN_AUDIO_DIR = ("/home/douglas/maori-language-monitoring/"
                   "data/8k-60s/train-%ss" % TRAIN_FILE_LENGTH)
TEST_AUDIO_DIR = ("/home/douglas/maori-language-monitoring/"
                   "data/8k-60s/validate-%ss" % TRAIN_FILE_LENGTH)

def main(argv):
    gst_init()
    if '-q' in argv:
        argv.remove('-q')
        quiet = True
    else:
        quiet = False
    if argv:
        lr = lr_steps(*(float(x) for x in argv))

    else:
        lr = lr_steps(3e-6, 360 // TRAIN_FILE_LENGTH,
                      1e-6, 1920 // TRAIN_FILE_LENGTH,
                      3e-7)

    train_data = categorised_files(TRAIN_AUDIO_DIR, CLASSES)
    test_data = categorised_files(TEST_AUDIO_DIR, CLASSES)

    c = Trainer(mfccs=MFCCS, hsize=HIDDEN_SIZE,
                channels=72,
                classes=CLASSES)
    c.quiet = quiet
    c.train(train_data, test_data, iterations=15000 // TRAIN_FILE_LENGTH,
            learn_rate=lr, log_file=NET_LOG_FILE,
            properties=(('momentum-soft-start', 4000),
                        ('momentum', 0.97),
                        #('mfccs', 0),
                        ))


main(sys.argv[1:])
