#!/usr/bin/python
import os, sys
import random
import itertools
import time

from classify import gst_init
from classify import TMP_CLASSES as CLASSES
from classify import TMP_HIDDEN_SIZE as HIDDEN_SIZE
from classify import Trainer, lr_steps, categorised_files

TRAIN_FILE_LENGTH=5

NET_LOG_FILE = "classify.log"

TRAIN_AUDIO_DIR = ("/home/douglas/maori-language-monitoring/"
                   "data/8k-60s/train-%ss" % TRAIN_FILE_LENGTH)
TEST_AUDIO_DIR = ("/home/douglas/maori-language-monitoring/"
                   "data/8k-60s/validate-%ss" % TRAIN_FILE_LENGTH)

def main(argv):
    gst_init()
    if '-q' in argv:
        argv.remove('-q')
        quiet = True
    else:
        quiet = False
    if argv:
        lr = lr_steps(*(float(x) for x in argv))

    else:
        lr = lr_steps(#1e-3, 240 // TRAIN_FILE_LENGTH,
                      #1e-4, 240 // TRAIN_FILE_LENGTH,
                      1e-5, 360 // TRAIN_FILE_LENGTH,
                      3e-6, 720 // TRAIN_FILE_LENGTH,
                      1e-6)

    train_data = categorised_files(TRAIN_AUDIO_DIR, CLASSES)
    test_data = categorised_files(TEST_AUDIO_DIR, CLASSES)

    c = Trainer(hsize=HIDDEN_SIZE,
                channels=72,
                classes=CLASSES)
    c.quiet = quiet
    c.train(train_data, test_data, iterations=10000 // TRAIN_FILE_LENGTH,
            learn_rate=lr, log_file=NET_LOG_FILE)


main(sys.argv[1:])
