#!/usr/bin/python
import os, sys
import random
import itertools
import time
import argparse

from classify import gst_init
from classify_kiwi import MFCCS, WINDOW_SIZE, BASENAME
from classify import COLOURS, targeted_wav_finder
from classify import Trainer, lr_steps, categorised_files, load_binary_timings

NET_LOG_FILE = "kiwi.log"


def main():
    gst_init()
    parser = argparse.ArgumentParser()
    parser.add_argument('-v', '--verbose', action='store_true',
                        help='lots of rubbish output')
    parser.add_argument('-t', '--timings', action='append',
                        help='read timings from here')
    parser.add_argument('-d', '--audio-directory', action='append',
                        help='find audio in this directory')
    parser.add_argument('-l', '--learn-rate', type=float,
                        help="learning rate")
    parser.add_argument('-i', '--iterations', type=int, default=10000,
                        help="how many file cycles to run for")
    parser.add_argument('-H', '--hidden-size', type=int,
                        help="number of hidden neurons")
    parser.add_argument('-B', '--bottom-layer', type=int,
                        help="number of bottom layer output nodes")
    parser.add_argument('-N', '--no-save-net', action='store_true',
                        help="don't save the net, periodically or otherwise")
    parser.add_argument('-c', '--classes', default='tf',
                        help="classes (letter per class, groups separated by '|')")
    parser.add_argument('-C', '--channels', default=12, type=int,
                        help="how many channels to use")
    parser.add_argument('-w', '--window-size', default=WINDOW_SIZE, type=int,
                        help="size of the FFT window")
    parser.add_argument('-n', '--basename', default=BASENAME,
                        help="save nets etc using this basename")
    parser.add_argument('-r', '--random-alignment', action='store_true',
                        help="slightly randomise alignment of fft windows")

    args = parser.parse_args()
    if args.learn_rate:
        lr = lr_steps(args.learn_rate)
    else:
        lr = lr_steps(
            #1e-4, 200,
            1e-5, 20,
            3e-6, 20,
            1e-6, 40,
            3e-7, 64,
            1e-7, 2000,
            3e-8)
    if 0:
        dropout = lr_steps(0.5, 100,
                           0.4, 100,
                           0.3, 100,
                           0.2, 100,
                           0.1, 100,
                           0
                       )
    else:
        dropout = 0




    all_classes = args.classes.split('|')
    timings = {}
    for fn in args.timings:
        timings.update(load_binary_timings(fn, all_classes))
    #timings = coalesce_timings(timings)

    timed_files = []
    for d in args.audio_directory:
        timed_files.extend(targeted_wav_finder(d, timings))

    random.seed(1)
    random.shuffle(timed_files)

    #print timings
    full_timings = {ffn: timings[fn] for fn, ffn in timed_files}

    n_channels = args.channels
    validate_streams = [[ffn for fn, ffn in timed_files[:n_channels]]]
    training_streams = [[ffn for fn, ffn in timed_files[n_channels:]]]

    for x in training_streams:
        random.shuffle(x)

    c = Trainer(mfccs=MFCCS,
                hsize=args.hidden_size,
                channels=n_channels,
                classes=all_classes,
                window_size=args.window_size,
                basename=args.basename)

    c.no_save_net = args.no_save_net
    c.quiet = not args.verbose
    c.timings = full_timings

    c.classifier.set_property('random-alignment', args.random_alignment)

    if args.bottom_layer:
        c.classifier.set_property('bottom-layer', args.bottom_layer)

    c.train(training_streams, validate_streams, iterations=args.iterations,
            learn_rate=lr, dropout=dropout, log_file=NET_LOG_FILE,
            properties=(('momentum-soft-start', 10000),
                        ('momentum', 0.95),
                        ('momentum-style', 1),
                        ('weight-fan-in-sum', 3),
                        ('weight-fan-in-kurtosis', 0.1),
                        #('error-weight', '3:2'),
                    ))

main()
